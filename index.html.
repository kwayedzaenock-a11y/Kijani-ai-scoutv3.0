<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kijani-AI Precision Scout</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
        }
        /* Custom styling for security lock and loading */
        .lock-screen {
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .diagnosis-button-ready {
            background-color: #10b981; /* Green */
        }
        .diagnosis-button-waiting {
            background-color: #f59e0b; /* Amber/Yellow */
        }
        
        /* Markdown rendering styles */
        #diagnosisOutput h3 {
            font-size: 1.125rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #047857; /* green-700 */
            margin-top: 1.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #d1d5db; /* gray-300 */
        }
        #diagnosisOutput p {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            color: #374151; /* gray-700 */
            line-height: 1.5;
        }
        #diagnosisOutput ul {
            list-style: disc;
            margin-left: 1.5rem;
            padding-left: 0.5rem;
            margin-top: 0.5rem;
        }
        #diagnosisOutput li {
            margin-bottom: 0.25rem;
            color: #374151; /* gray-700 */
        }
    </style>
</head>
<body>

    <!-- Security PIN Lock Screen (Biosecurity) -->
    <div id="lockScreen" class="lock-screen fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-90 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center mx-4">
            <svg class="w-12 h-12 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            <h2 id="lockTitle" class="text-2xl font-bold text-gray-800 mb-2">Set Your PIN</h2>
            <p id="lockInstructions" class="text-sm text-gray-600 mb-4">Enter a 4-digit PIN for biosecurity owner access.</p>
            <input type="password" id="pinInput" maxlength="4" class="w-full text-4xl text-center tracking-widest p-3 border-2 border-green-400 rounded-lg focus:ring-green-500 focus:border-green-500 transition shadow-inner" pattern="\d{4}" inputmode="numeric">
            <button onclick="handlePinAction()" id="pinButton" class="mt-6 w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150">
                Set PIN
            </button>
            <p id="pinStatus" class="text-sm text-red-500 mt-4"></p>
        </div>
    </div>

    <!-- Main Application UI -->
    <div id="app" class="min-h-screen flex flex-col items-center p-4 w-full max-w-lg opacity-0 transition-opacity duration-500">

        <!-- Header -->
        <header class="w-full max-w-lg mb-4 bg-white shadow-lg rounded-xl p-4 flex justify-between items-center border-b-4 border-green-400">
            <h1 class="text-xl font-extrabold text-green-700 leading-tight">
                Kijani-AI Scout <span id="versionDisplay" class="text-xs ml-2 px-2 py-1 bg-gray-100 rounded-full text-gray-500">v3.0.1</span>
            </h1>
            <div class='flex space-x-2'>
                <button onclick="checkForUpdate()" class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition duration-150 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0020 13a8 8 0 00-2.583-5.874M16 10V5h-.582m-15.356 2A8.001 8.001 0 004 11a8 8 0 002.583 5.874"></path></svg>
                    Update
                </button>
                <button onclick="lockApp()" class="text-sm px-3 py-1 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition duration-150 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    Lock
                </button>
            </div>
        </header>

        <!-- Input Section -->
        <main class="w-full max-w-lg">
            <div class="bg-white p-6 rounded-xl shadow-xl mb-6">
                
                <!-- CRITICAL: API Key Input -->
                <div class="mb-6 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                    <label for="apiKeyInput" class="block text-sm font-bold text-gray-700 mb-2">
                        <span class="text-red-600 font-extrabold">*</span> API Key (Required for Diagnosis):
                    </label>
                    <input type="password" id="apiKeyInput" oninput="updateDiagnosisButtonState()" class="w-full p-2 border border-yellow-300 rounded-lg text-sm focus:ring-yellow-500 focus:border-yellow-500" placeholder="Paste your personal Gemini API Key here.">
                    <p class="text-xs text-gray-500 mt-1">This key enables the AI analysis and is required due to external hosting limitations.</p>
                </div>
                
                
                <!-- Location & Mapping Section -->
                <div class="mb-6 border-b pb-4">
                    <h2 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.899c-.781.781-2.047.781-2.828 0L6.343 16.657A8 8 0 1117.657 16.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> 
                        Location & Mapping (Optional)
                    </h2>
                    
                    <!-- GPS Input Fields (Editable) -->
                    <div class="flex space-x-3 mb-3">
                        <input 
                            type="text" 
                            id="latitudeInput"
                            placeholder="Latitude (e.g., -1.2833)"
                            class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                        <input 
                            type="text" 
                            id="longitudeInput"
                            placeholder="Longitude (e.g., 36.8167)"
                            class="w-1/2 p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>

                    <!-- Get GPS Button -->
                    <button 
                        onclick="getGeolocation()" 
                        id="getLocationButton"
                        class="w-full px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150 focus:outline-none focus:ring-4 focus:ring-blue-300 text-sm mb-3 disabled:opacity-50"
                    >
                        Get Current GPS
                    </button>

                    <!-- Mapping Controls -->
                    <div class="flex space-x-3 items-center">
                        <button 
                            onclick="toggleMapping()"
                            id="mappingButton" 
                            class="flex-shrink-0 px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-150 focus:outline-none focus:ring-4 focus:ring-yellow-300 text-sm"
                        >
                            Start Area Mapping
                        </button>
                        <div id="mappingStatus" class="flex-grow p-2 bg-gray-100 rounded-lg text-xs text-gray-600 truncate">
                            Status: Idle. 0 points captured.
                        </div>
                    </div>
                </div>
                
                <!-- Sensor Data Input -->
                <label for="sensorInput" class="block text-sm font-bold text-gray-700 mb-2">Sensor Data (e.g., NPK, pH, Moisture):</label>
                <textarea 
                    id="sensorInput" 
                    rows="2" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 shadow-sm mb-4 text-sm" 
                    placeholder="Paste data: e.g., pH: 5.2, N: 15 ppm, K: 250 ppm, Moisture: 60%"
                ></textarea>

                <!-- Image Upload and Preview -->
                <label class="block text-sm font-bold text-gray-700 mb-2">Upload Plant Image:</label>
                <div class="mb-4 p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-green-500 transition duration-150">
                    <input 
                        type="file" 
                        id="imageInput" 
                        accept="image/*" 
                        onchange="previewImage(event)"
                        class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
                    />
                    <img id="imagePreview" class="mt-4 w-full h-auto max-h-64 object-contain rounded-lg shadow-md hidden" alt="Image Preview">
                </div>

                <!-- Symptom Description -->
                <label for="symptomInput" class="block text-sm font-bold text-gray-700 mb-2">Describe Symptoms:</label>
                <textarea 
                    id="symptomInput" 
                    rows="3" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 shadow-sm text-sm" 
                    placeholder="e.g., Small, yellow-to-orange pustules on the underside of wheat leaves."
                ></textarea>
                
                <!-- Diagnosis Button & Status -->
                <button 
                    onclick="runDiagnosis()" 
                    id="diagnoseButton" 
                    class="mt-6 w-full px-4 py-3 text-white font-bold rounded-xl shadow-lg transition duration-150 focus:outline-none focus:ring-4 focus:ring-yellow-300 disabled:opacity-50 diagnosis-button-waiting"
                    disabled
                >
                    Paste API Key to Enable Diagnosis
                </button>
                
                <!-- Status Message Display -->
                <p id="statusMessage" class="text-sm text-center mt-3 p-2 rounded-lg font-medium"></p>
                
            </div>

            <!-- Diagnosis Report Section -->
            <div id="resultsContainer" class="w-full max-w-lg mt-8 mb-8 hidden">
                <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-green-500">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">
                        Kijani-AI Diagnosis Report
                    </h2>
                    <div id="diagnosisOutput">
                        <!-- Content will be injected here -->
                    </div>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="mt-8 hidden p-6 bg-white rounded-xl shadow-lg flex items-center space-x-3 text-gray-600">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                <span>Analyzing all data streams...</span>
            </div>

        </main>

    </div>

    <script>
        // --- Configuration and State ---
        const PIN_KEY = 'kijani_ai_pin_hash_v3';
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const MAX_RETRIES = 3;
        const CURRENT_VERSION = "v3.0.1";

        let scoutedArea = [];

        // --- Utility Functions ---

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function setStatusMessage(message, isError = false) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            
            const className = isError 
                ? 'bg-red-100 text-red-600' 
                : 'bg-green-100 text-gray-700';

            statusElement.className = `text-sm text-center mt-3 p-2 rounded-lg font-medium flex items-center justify-center ${className}`;
            statusElement.style.display = 'flex';
        }

        function clearStatusMessage() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        // --- PIN Lock Functions (Biosecurity) ---
        
        function getPinState() {
            return localStorage.getItem(PIN_KEY) ? 'locked' : 'setup';
        }

        window.handlePinAction = async function() {
            const pinInput = document.getElementById('pinInput');
            const pinButton = document.getElementById('pinButton');
            const pinStatus = document.getElementById('pinStatus');
            const pin = pinInput.value;

            if (pin.length !== 4 || isNaN(pin)) {
                pinStatus.textContent = "PIN must be 4 digits.";
                return;
            }
            pinStatus.textContent = "";

            const currentState = getPinState();
            const pinHash = await sha256(pin);

            if (currentState === 'setup') {
                localStorage.setItem(PIN_KEY, pinHash);
                pinStatus.textContent = "PIN set successfully!";
                setTimeout(unlockApp, 500);
            } else if (currentState === 'locked') {
                const storedHash = localStorage.getItem(PIN_KEY);
                if (pinHash === storedHash) {
                    pinStatus.textContent = "Unlocked! All features enabled.";
                    setTimeout(unlockApp, 500);
                } else {
                    pinStatus.textContent = "Incorrect PIN. Access Denied (Biosecurity).";
                }
            }
            pinInput.value = '';
        };

        function checkLockStatus() {
            const lockScreen = document.getElementById('lockScreen');
            const lockTitle = document.getElementById('lockTitle');
            const lockInstructions = document.getElementById('lockInstructions');
            const pinButton = document.getElementById('pinButton');
            
            if (getPinState() === 'setup') {
                lockScreen.classList.remove('hidden');
                lockTitle.textContent = "Set Biosecurity PIN";
                lockInstructions.textContent = "Enter a 4-digit PIN for owner access.";
                pinButton.textContent = "Set PIN";
            } else {
                lockScreen.classList.remove('hidden');
                lockTitle.textContent = "Access Control";
                lockInstructions.textContent = "Please enter your 4-digit security PIN.";
                pinButton.textContent = "Unlock Access";
            }
        }

        function unlockApp() {
            document.getElementById('lockScreen').classList.add('opacity-0');
            setTimeout(() => document.getElementById('lockScreen').classList.add('hidden'), 500);
            document.getElementById('app').classList.remove('opacity-0');
            
            // Check API key status immediately after unlocking
            updateDiagnosisButtonState();
        }

        window.lockApp = function() {
            document.getElementById('app').classList.add('opacity-0');
            document.getElementById('lockScreen').classList.remove('hidden', 'opacity-0');
            checkLockStatus();
        }

        // --- Version Check ---
        window.checkForUpdate = function() {
            clearStatusMessage();
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');

            setTimeout(() => {
                loadingIndicator.classList.add('hidden');
                setStatusMessage(`Kijani-AI is running the latest version: ${CURRENT_VERSION}`);
            }, 1500);
        };
        
        // --- Geolocation and Mapping Functions ---
        
        function updateMappingStatus() {
            const mappingButton = document.getElementById('mappingButton');
            const mappingStatus = document.getElementById('mappingStatus');

            mappingStatus.textContent = window.isMapping 
                ? `Status: MAPPING. ${scoutedArea.length} points captured.`
                : `Status: Idle. ${scoutedArea.length} points in memory.`;
            
            mappingButton.textContent = window.isMapping ? "Stop Mapping" : "Start Area Mapping";
            mappingButton.classList.remove('bg-yellow-500', 'bg-red-500');
            mappingButton.classList.add(window.isMapping ? 'bg-red-500' : 'bg-yellow-500');
        }

        window.toggleMapping = function() {
            window.isMapping = !window.isMapping;
            if (window.isMapping) {
                scoutedArea = [];
                setStatusMessage("Mapping started. Your location will be captured with every 'Get Current GPS' click.");
            } else {
                if (scoutedArea.length < 3) {
                    setStatusMessage(`Mapping stopped. Area polygon requires at least 3 points. ${scoutedArea.length} captured.`, true);
                    scoutedArea = [];
                } else {
                    setStatusMessage(`Mapping complete! ${scoutedArea.length} points recorded.`);
                }
            }
            updateMappingStatus();
        };
        
        window.getGeolocation = function() {
            clearStatusMessage();
            const getLocationButton = document.getElementById('getLocationButton');
            const latitudeInput = document.getElementById('latitudeInput');
            const longitudeInput = document.getElementById('longitudeInput');

            if (!navigator.geolocation) {
                setStatusMessage('Geolocation not supported by this browser.', true);
                return;
            }
            
            getLocationButton.disabled = true;
            getLocationButton.textContent = 'Fetching...';

            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lon = position.coords.longitude.toFixed(6);
                
                latitudeInput.value = lat;
                longitudeInput.value = lon;
                
                getLocationButton.disabled = false;
                getLocationButton.textContent = 'Get Current GPS';
                
                if (window.isMapping) {
                    scoutedArea.push({ lat, lon });
                    setStatusMessage(`Point added! Total points: ${scoutedArea.length}`);
                    updateMappingStatus();
                } else {
                    setStatusMessage(`Current point captured: Lat ${lat}, Lon ${lon}.`);
                }
            }, (error) => {
                getLocationButton.disabled = false;
                getLocationButton.textContent = 'Get Current GPS';
                
                let message = "Geolocation Error. ";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message += "Permission Denied. Grant access when prompted (Code 1).";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += "Position Unavailable (Code 2).";
                        break;
                    case error.TIMEOUT:
                        message += "Request Timed Out (Code 3).";
                        break;
                    default:
                        message += `Unknown Error Code ${error.code}.`;
                }
                setStatusMessage(message, true);
            }, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            });
        };

        // --- Image Handling Functions ---
        window.previewImage = function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            clearStatusMessage();
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
            } else {
                preview.src = '';
                preview.classList.add('hidden');
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // 8MB limit (safe buffer for API)
                    if (file.size > 8 * 1024 * 1024) { 
                        reject(new Error("Image is too large (over 8MB). Please upload a compressed image."));
                    }
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- Diagnosis Button State ---
        window.updateDiagnosisButtonState = function() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const diagnoseButton = document.getElementById('diagnoseButton');
            const keyIsPresent = apiKeyInput.value.trim().length > 10; // Simple check for presence

            diagnoseButton.disabled = !keyIsPresent;
            diagnoseButton.classList.remove('diagnosis-button-ready', 'diagnosis-button-waiting');

            if (keyIsPresent) {
                diagnoseButton.textContent = 'Run AI Diagnosis';
                diagnoseButton.classList.add('diagnosis-button-ready');
            } else {
                diagnoseButton.textContent = 'Paste API Key to Enable Diagnosis';
                diagnoseButton.classList.add('diagnosis-button-waiting');
            }
        };


        // --- Core runDiagnosis Function (Uses User-Provided Key) ---
        window.runDiagnosis = async function() {
            clearStatusMessage();
            const apiKeyInput = document.getElementById('apiKeyInput');
            const userApiKey = apiKeyInput.value.trim();
            
            const symptomInput = document.getElementById('symptomInput');
            const imageInput = document.getElementById('imageInput');
            const sensorData = document.getElementById('sensorInput').value.trim();
            const latitude = document.getElementById('latitudeInput').value.trim();
            const longitude = document.getElementById('longitudeInput').value.trim();
            
            const prompt = symptomInput.value.trim();
            const file = imageInput.files[0];

            if (!userApiKey) {
                setStatusMessage("CRITICAL: API Key is missing. Please paste your Gemini key to enable diagnosis.", true);
                return;
            }
            if (!prompt && !file) {
                setStatusMessage("Please provide a photo or describe the symptoms (or both).", true);
                return;
            }
            
            const diagnoseButton = document.getElementById('diagnoseButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const diagnosisOutput = document.getElementById('diagnosisOutput');
            const resultsContainer = document.getElementById('resultsContainer');

            diagnoseButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            diagnosisOutput.innerHTML = '';
            resultsContainer.classList.add('hidden');

            try {
                let base64Image = null;
                if (file) {
                    setStatusMessage('Uploading and preparing image...');
                    base64Image = await fileToBase64(file);
                }
                
                setStatusMessage('Analyzing all data streams...');
                
                const locationData = { lat: latitude, lon: longitude, mapping: scoutedArea, sensorData: sensorData };
                const resultText = await fetchDiagnosis(prompt, base64Image, locationData, userApiKey);
                
                if (resultText) {
                    displayDiagnosis(resultText);
                    resultsContainer.classList.remove('hidden');
                    setStatusMessage("Diagnosis complete. See report below.");
                } else {
                    throw new Error("API returned an empty diagnosis result.");
                }

            } catch (error) {
                console.error("Diagnosis failed:", error);
                setStatusMessage(`Analysis Failed: ${error.message}`, true);
                diagnosisOutput.innerHTML = `<p class="text-red-600 font-bold">Analysis Failed:</p><p class="text-red-500">${error.message}</p><p class="text-gray-500 mt-2">Check your API key validity and network connection.</p>`;
                resultsContainer.classList.remove('hidden');
            } finally {
                diagnoseButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                updateDiagnosisButtonState(); // Re-enable if key is still present
            }
        };

        // --- LLM API Call Logic (Now uses user key) ---
        async function fetchDiagnosis(prompt, base64Image, locationData, apiKey, attempt = 0) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;
            
            const parts = [];
            let fullPrompt = prompt;

            // 1. Add location and scouting context to the prompt
            if (locationData.lat && locationData.lon) {
                fullPrompt += `\n\nScouting Location: Latitude ${locationData.lat}, Longitude ${locationData.lon}.`;
            }
            if (locationData.mapping.length > 0) {
                fullPrompt += `\n\nArea Boundary: A polygon area containing ${locationData.mapping.length} scouted points has been defined. Adjust recommendations for zone-specific VRA treatment.`;
            }
            if (locationData.sensorData) {
                fullPrompt = `Sensor Data: ${locationData.sensorData}\n\nSymptom Description: ${fullPrompt}`;
            }

            const SYSTEM_PROMPT = `You are a specialized agricultural diagnosis AI named Kijani-AI, focusing on precision scouting. Analyze ALL provided inputs (Image, Symptom Description, Location/Scouting Data, and Sensor Data). Provide a single, most likely identification, and detail the five key aspects.

            Sensor Data is critical: If a nutrient deficiency is suggested by the visual symptoms, use the provided NPK/pH/Moisture readings to confirm or deny that specific deficiency and adjust your recommendations accordingly.

            Format your response clearly using the following mandatory headings exactly as written (in Markdown): 
            
            ### Disease/Organism
            [Your identified disease name or confirmed nutrient deficiency and the causative agent]
            
            ### Effects
            [List the primary damage and impact on the plant and yield.]
            
            ### Causes/Conditions
            [List the environmental conditions, host factors, or vectors that cause or favor this disease. MUST integrate sensor data confirmation if provided.]
            
            ### Recommended Control Measures
            [Provide specific, practical, and grounded recommendations for immediate management and control.]
            
            ### Broader Agricultural Practices
            [Provide general, preventative, and long-term farm management practices.]`;

            parts.push({ text: fullPrompt });
            
            if (base64Image) {
                parts.push({
                    inlineData: {
                        mimeType: 'image/jpeg', 
                        data: base64Image
                    }
                });
            }

            const payload = {
                contents: [{ role: "user", parts: parts }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    let errorDetails = `HTTP Status ${response.status} (${response.statusText})`;
                    if (response.status === 403 || response.status === 400) {
                        // This error should now only occur if the API key itself is wrong.
                        errorDetails += " - Authorization Failed. (Check API key validity).";
                    }
                    throw new Error(`API Error: ${errorDetails}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("API response was valid but contained no generated text.");
                }

                return text;

            } catch (error) {
                if (attempt < MAX_RETRIES - 1) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchDiagnosis(prompt, base64Image, locationData, apiKey, attempt + 1); 
                } else {
                    throw error;
                }
            }
        }

        // --- Display Logic ---
        function displayDiagnosis(markdownText) {
            const diagnosisOutput = document.getElementById('diagnosisOutput');
            // This relies on the CSS styling above to format the markdown output
            let htmlContent = markdownText
                .replace(/^### (.*)$/gm, '<h3>$1</h3>')
                .replace(/^\* (.*)$/gm, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, ' ');

            // Basic list wrapping
            htmlContent = htmlContent.replace(/<li>/g, '<ul><li>').replace(/<\/li>/g, '</li></ul>').replace(/<\/ul>\s*<ul>/g, '');
            // Wrap in an initial paragraph
            htmlContent = `<p>${htmlContent}</p>`;
            
            diagnosisOutput.innerHTML = htmlContent;
        }

        // Initialize on load
        window.onload = function() {
            document.getElementById('versionDisplay').textContent = CURRENT_VERSION;
            checkLockStatus();
            clearStatusMessage();
        };

    </script>
</body>
</html>

